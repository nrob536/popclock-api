<!-- Population Clock Widget - Embeddable in CMS -->
<div class="nz-population-clock-widget">
  <style scoped>
    .nz-population-clock-widget {
      font-family: 'Segoe UI', Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    .nz-population-clock-widget .demo-disclaimer {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 1em;
      margin: 1em auto;
      max-width: 800px;
      text-align: center;
      font-weight: bold;
      color: #856404;
    }
    .nz-population-clock-widget .demo-disclaimer .warning-icon {
      font-size: 1.5em;
      margin-right: 0.5em;
    }
    .nz-population-clock-widget .clock-container {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.1);
      display: inline-block;
      margin: 2em auto;
      padding: 2.5em 2em 2em 2em;
      max-width: 100%;
    }
    .nz-population-clock-widget .main-count {
      font-size: 3.5em;
      font-weight: bold;
      color: #0086b3;
      margin-bottom: 1em;
      letter-spacing: 0.05em;
      transition: color 0.3s;
    }
    .nz-population-clock-widget .sub-counts {
      display: flex;
      justify-content: center;
      gap: 2em;
      margin-bottom: 1em;
      flex-wrap: wrap;
    }
    .nz-population-clock-widget .sub-counts div {
      font-size: 1.2em;
    }
    .nz-population-clock-widget .timestamp {
      color: #666;
      font-size: 0.95em;
      margin-top: 1em;
    }
    .nz-population-clock-widget .caveat {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1.5em;
      margin: 2em auto;
      max-width: 800px;
      text-align: left;
      font-size: 0.9em;
      line-height: 1.6;
      color: #333;
    }
    .nz-population-clock-widget .caveat h3 {
      margin-top: 0;
      color: #0086b3;
      font-size: 1.1em;
    }
    .nz-population-clock-widget .caveat p {
      margin: 1em 0;
    }
    .nz-population-clock-widget .caveat ul {
      margin: 1em 0;
      padding-left: 1.5em;
    }
    @media (max-width: 600px) {
      .nz-population-clock-widget .clock-container {
        padding: 1em 0.5em;
        margin: 1em auto;
      }
      .nz-population-clock-widget .main-count {
        font-size: 2.5em;
      }
      .nz-population-clock-widget .sub-counts {
        gap: 1em;
      }
      .nz-population-clock-widget .sub-counts div {
        font-size: 1em;
      }
      .nz-population-clock-widget .caveat {
        margin: 1em;
        padding: 1em;
        font-size: 0.85em;
      }
    }
  </style>

  <div class="demo-disclaimer">
    <span class="warning-icon">⚠️</span>
    <strong>DEMO ONLY:</strong> This population clock displays synthetically generated data for demonstration purposes only. 
    The numbers shown are not actual New Zealand population statistics.
  </div>

  <div class="clock-container">
    <div class="main-count" id="nz-pop-estimate">Loading…</div>
    <div class="sub-counts">
      <div>Births: <span id="nz-births">0</span></div>
      <div>Deaths: <span id="nz-deaths">0</span></div>
      <div>Net migration: <span id="nz-migration">0</span></div>
    </div>
    <div class="timestamp" id="nz-timestamp"></div>
  </div>
  
  <div class="caveat">
    <h3>About the Population Clock</h3>
    <p><strong>⚠️ IMPORTANT:</strong> The data displayed in this demonstration is <strong>synthetically generated</strong> and does not represent actual New Zealand population statistics. This is a technical demonstration only.</p>
    <p>In a real implementation, New Zealand's population would be estimated as published by Statistics NZ:</p>
    <p><a href="https://www.stats.govt.nz/tools/population-clock/" target="_blank">https://www.stats.govt.nz/tools/population-clock/</a></p> 
    <p>Based on current methodology the population is expected to increase by one person every 21 minutes and 2 seconds.</p>
    <p>This is based on the estimated resident population at 31 March 2025 and the following forecasts:</p>
    <ul>
      <li>one birth every 9 minutes and 1 second</li>
      <li>one death every 14 minutes and 46 seconds</li>
      <li>one net migration every 3 hours, 52 minutes and 9 seconds.</li>
    </ul>
    <p>The forecasts are based on recent trends and do not necessarily reflect actual population change.</p>
    <p>The population clock is based on the estimated resident population and does not correspond to the census usually resident population count or census night population count.</p>
    <p>The estimated resident population is derived from the 2023 Census usually resident population count, with adjustments for people missed or counted more than once by the census (net census undercount), residents temporarily overseas on census night, and population change since census night.</p>
    <p><strong>For the latest available data on population, births, deaths, and migration see:</strong></p>
    <ul>
      <li><strong>Estimates and projections</strong> – information about the current and future New Zealand population.</li>
      <li><strong>Population indicators</strong> – summary of New Zealand's key demographic statistics (population, births, deaths, marriages, migration etc).</li>
    </ul>
  </div>
</div>

<script>
(function() {
  // Namespace the widget to avoid conflicts
  const NZPopClock = {
    // CONFIG
    API_URL: "https://popclock-api.onrender.com/clock/estimate?format=json",
    SYNC_INTERVAL: 30000, // ms between backend syncs
    TIMESTAMP_UPDATE_INTERVAL: 1000, // ms between timestamp updates
    
    // Population change rates
    POPULATION_CHANGE_INTERVAL: 21 * 60 + 2, // seconds
    BIRTH_INTERVAL: 9 * 60 + 1, // seconds
    DEATH_INTERVAL: 14 * 60 + 46, // seconds
    MIGRATION_INTERVAL: 3 * 3600 + 52 * 60 + 9, // seconds

    // STATE
    lastData: null,
    lastTimestamp: null,
    baseTimestamp: null,
    currentTime: new Date(),
    intervals: [],

    // UTILITY
    extractValue: function(x) {
      if (Array.isArray(x)) {
        return x.length > 0 ? x[0] : 0;
      }
      return x;
    },

    setText: function(id, value) {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = value;
      }
    },

    updateTimestamp: function() {
      this.currentTime = new Date();
      this.setText("nz-timestamp", "Updated: " + this.currentTime.toLocaleString());
    },
    
    updatePopulationEstimates: function() {
      if (!this.lastData || !this.baseTimestamp) return;
      
      const now = new Date();
      const elapsedSeconds = (now - this.baseTimestamp) / 1000;
      
      // Calculate changes
      const populationIncrease = Math.floor(elapsedSeconds / this.POPULATION_CHANGE_INTERVAL);
      const birthIncrease = Math.floor(elapsedSeconds / this.BIRTH_INTERVAL);
      const deathIncrease = Math.floor(elapsedSeconds / this.DEATH_INTERVAL);
      const migrationIncrease = Math.floor(elapsedSeconds / this.MIGRATION_INTERVAL);
      
      // Update estimates
      const newPop = this.extractValue(this.lastData.estimate) + populationIncrease;
      const newBirths = this.extractValue(this.lastData.births) + birthIncrease;
      const newDeaths = this.extractValue(this.lastData.deaths) + deathIncrease;
      const newMigration = this.extractValue(this.lastData.migration) + migrationIncrease;
      
      // Update UI
      this.setText("nz-pop-estimate", newPop.toLocaleString());
      this.setText("nz-births", newBirths.toLocaleString());
      this.setText("nz-deaths", newDeaths.toLocaleString());
      this.setText("nz-migration", newMigration.toLocaleString());
    },

    fetchAndReset: async function() {
      try {
        const resp = await fetch(this.API_URL);
        if (!resp.ok) throw new Error("API error: " + resp.status);
        const data = await resp.json();

        const estimate = this.extractValue(data.estimate);
        const births = this.extractValue(data.births);
        const deaths = this.extractValue(data.deaths);
        const migration = this.extractValue(data.migration);
        const timestamp = this.extractValue(data.timestamp);

        this.lastData = data;
        this.lastTimestamp = new Date(timestamp.replace(' ', 'T') + 'Z');
        this.baseTimestamp = new Date();
        
        this.setText("nz-pop-estimate", estimate.toLocaleString());
        this.setText("nz-births", births.toLocaleString());
        this.setText("nz-deaths", deaths.toLocaleString());
        this.setText("nz-migration", migration.toLocaleString());
        this.setText("nz-timestamp", "Data as at: " + timestamp + " UTC");
        
        this.updatePopulationEstimates();
      } catch (e) {
        this.setText("nz-pop-estimate", "Error!");
        this.setText("nz-timestamp", "API not reachable or returned error.");
        this.setText("nz-births", 0);
        this.setText("nz-deaths", 0);
        this.setText("nz-migration", 0);
      }
    },

    init: function() {
      // Clear any existing intervals
      this.intervals.forEach(interval => clearInterval(interval));
      this.intervals = [];

      // Start the clock
      this.fetchAndReset();
      this.intervals.push(setInterval(() => this.fetchAndReset(), this.SYNC_INTERVAL));
      this.intervals.push(setInterval(() => this.updateTimestamp(), this.TIMESTAMP_UPDATE_INTERVAL));
      this.intervals.push(setInterval(() => this.updatePopulationEstimates(), this.POPULATION_CHANGE_INTERVAL * 1000));
    },

    destroy: function() {
      // Clean up intervals when widget is removed
      this.intervals.forEach(interval => clearInterval(interval));
      this.intervals = [];
    }
  };

  // Auto-initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => NZPopClock.init());
  } else {
    NZPopClock.init();
  }

  // Expose for manual control if needed
  window.NZPopClock = NZPopClock;
})();
</script>
